{"version":3,"sources":["../../../src/modules/ws/ws.guard.ts"],"sourcesContent":["import { GUARDS } from \"@/utils/constants\";\nimport { Inject, Injectable } from \"@nestjs/common\";\nimport { ConfigService } from \"@nestjs/config\";\nimport { AuthGuard } from \"@nestjs/passport\";\nimport { AuthService } from \"@/modules\";\n\nimport type { ExecutionContext } from \"@nestjs/common\";\nimport { WsException } from \"@nestjs/websockets\";\n\n@Injectable()\nexport class WsGuard extends AuthGuard(GUARDS.AT) {\n  constructor(\n    @Inject(AuthService)\n    private readonly authService: AuthService,\n    @Inject(ConfigService)\n    private readonly config: ConfigService,\n  ) {\n    super();\n  }\n\n  async canActivate(context: ExecutionContext) {\n    const client = context.switchToWs().getClient();\n    const headers = client?.handshake?.headers;\n\n    if (!headers.authorization) return false;\n\n    const token = headers.authorization;\n\n    const userToken = await this.authService.validateToken(token);\n\n    if (!userToken) throw new WsException(\"Invalid token\");\n\n    client[\"user\"] = userToken;\n\n    return true;\n  }\n}\n"],"names":["WsGuard","AuthGuard","GUARDS","AT","canActivate","context","client","switchToWs","getClient","headers","handshake","authorization","token","userToken","authService","validateToken","WsException","constructor","config","Injectable","Inject","AuthService","ConfigService"],"mappings":";;;;+BAUaA;;;eAAAA;;;2BAVU;wBACY;wBACL;0BACJ;yBACE;4BAGA;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAGfA,UAAN,sBAAsBC,IAAAA,mBAAS,EAACC,iBAAM,CAACC,EAAE;IAU9C,MAAMC,YAAYC,OAAyB,EAAE;QAC3C,MAAMC,SAASD,QAAQE,UAAU,GAAGC,SAAS;QAC7C,MAAMC,UAAUH,QAAQI,WAAWD;QAEnC,IAAI,CAACA,QAAQE,aAAa,EAAE,OAAO;QAEnC,MAAMC,QAAQH,QAAQE,aAAa;QAEnC,MAAME,YAAY,MAAM,IAAI,CAACC,WAAW,CAACC,aAAa,CAACH;QAEvD,IAAI,CAACC,WAAW,MAAM,IAAIG,uBAAW,CAAC;QAEtCV,MAAM,CAAC,OAAO,GAAGO;QAEjB,OAAO;IACT;IAxBAI,YAEmBH,aAEAI,OACjB;QACA,KAAK;+BAJYJ;+BAEAI;2BAFAJ;sBAEAI;IAGnB;AAkBF;AA1BalB;IADZmB,IAAAA,kBAAU;IAGNC,aAAAA,IAAAA,cAAM,EAACC,oBAAW;IAElBD,aAAAA,IAAAA,cAAM,EAACE,qBAAa;;;eADS,oBAAW,4BAAX,oBAAW;eAEhB,qBAAa,4BAAb,qBAAa;;GAL7BtB"}